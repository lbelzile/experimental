{
  "hash": "882d52ed0b1b8bfd309cbd14acfd20c0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"MATH 80667A - Week 10\"\nauthor: \"Léo Belzile\"\nformat: html\neval: true\necho: true\nmessage: false\nwarning: false\ncode-tools:\n      source: true\n      toggle: false\n      caption: \"Download Quarto file\"\n---\n\n::: {.cell}\n\n:::\n\n\n\n# Blocking factor\n\n\n\n::: {#tbl-anova-blocking .cell layout-ncol=\"2\" tbl-cap='Analysis of variance table' tbl-subcaption='[\"with blocking factor\",\"without the blocking factor\"]'}\n\n```{.r .cell-code}\nlibrary(emmeans)\nlibrary(hecedsm)\nlibrary(ggplot2)\nlibrary(afex)\nlibrary(lmerTest)\n# Force sum-to-zero parametrization for unordered factors\noptions(contrasts = c(\"contr.sum\", \"contr.poly\"))\n## Blocking factor\n# Note that this is fundamentally repeated measures\nurl <- \"https://edsm.rbind.io/files/data/resting_metabolic_rate.txt\"\n# transform integers to factors (categorical)\nresting <- read.table(url, header = TRUE) |>\n  dplyr::mutate(\n    subject = factor(subject), #blocking factor\n    protocol = factor(protocol), #experimental factor\n    rate = rate/1000)\n\n# Fit model with blocking factor\nmodel_block <- aov(rate ~ subject + protocol, data = resting)\n# One-way ANOVA (no blocking)\nmodel_raw <- aov(rate ~ protocol, data = resting)\n\n# ANOVA tables with and without blocking factor\nanova(model_block) |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|          | Df| Sum Sq| Mean Sq| F value| Pr(>F)|\n|:---------|--:|------:|-------:|-------:|------:|\n|subject   |  8| 23.117|   2.890|  37.423|  0.000|\n|protocol  |  2|  0.036|   0.018|   0.233|  0.795|\n|Residuals | 16|  1.235|   0.077|        |       |\n\n\n:::\n\n```{.r .cell-code}\nanova(model_raw) |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|          | Df| Sum Sq| Mean Sq| F value| Pr(>F)|\n|:---------|--:|------:|-------:|-------:|------:|\n|protocol  |  2|  0.036|   0.018|   0.018|  0.982|\n|Residuals | 24| 24.353|   1.015|        |       |\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use ANOVA table to compute etasquared effect size\n(etasq <- 0.0359/(23.1175 + 1.2355 + 0.0359))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.00147\n```\n\n\n:::\n\n```{.r .cell-code}\nefs <- effectsize::eta_squared(\n  model_block, \n  partial = TRUE,\n  generalized = \"subject\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Interaction plot\nggplot(data = resting,\n       aes(x = subject,\n           y = rate,\n           group = protocol,\n           color = protocol)) +\n  geom_line(linewidth = 1.5) +\n  labs(subtitle = \"mean resting metabolic rate\",\n       y = \"\",\n       x = \"subject identifier\") +\n  scale_color_grey()+\n  theme_classic() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![Interaction plot](MATH80667A-10-content_files/figure-html/fig-interaction-metabolic-1.png){#fig-interaction-metabolic width=672}\n:::\n:::\n\n\n\n# Mixed model\n\n## Hosano et al. (2022)\n\nThe purpose of this is to show the equivalence of repeated measures and mixed models for tests of interest\nin balanced designs with a single repeated measurement per individual, here captured through individual-specific random effects.\n\nWe consider three different models for `imscore` as a function of `waiting` (between-subject factor) and `ratingtype` (within-subject factor). Each individual `id` gives two ratings. The `id` are nested withing `waiting`, but crossed with `ratingtype`.\n\n- a mixed ANOVA (within-between) full-factorial design (i.e., including the interaction term),\n- a MANOVA with the two measurements of `imscore` by `ratingtype` as response,\n- a linear mixed model with a random effect for `id` and both `waiting`, `ratingtype` and their interaction.\n\n\n\n::: {.cell layout-ncol=\"3\"}\n\n```{.r .cell-code}\ndata(HOSM22_E3, package = 'hecedsm')\n# Pivot from long to wide for MANOVA\nHOSM22_E3w <- HOSM22_E3 |> tidyr::pivot_wider(\n  names_from = ratingtype,\n  values_from = imscore\n)\n\nxtabs(~ratingtype + waiting, HOSM22_E3) |>\n  knitr::kable() # crossed factors\n```\n\n::: {.cell-output-display}\n\n\n|           | long| short|\n|:----------|----:|-----:|\n|experience |   32|    31|\n|prediction |   32|    31|\n\n\n:::\n\n```{.r .cell-code}\nhead(xtabs(~id + waiting, HOSM22_E3), n = 5) |>\n  knitr::kable(row.names = TRUE) # id nested in waiting\n```\n\n::: {.cell-output-display}\n\n\n|   | long| short|\n|:--|----:|-----:|\n|1  |    0|     2|\n|2  |    2|     0|\n|3  |    2|     0|\n|4  |    0|     2|\n|5  |    2|     0|\n\n\n:::\n\n```{.r .cell-code}\nhead(xtabs(~id + ratingtype, HOSM22_E3), n = 5) |>\n  knitr::kable(row.names = TRUE)\n```\n\n::: {.cell-output-display}\n\n\n|   | experience| prediction|\n|:--|----------:|----------:|\n|1  |          1|          1|\n|2  |          1|          1|\n|3  |          1|          1|\n|4  |          1|          1|\n|5  |          1|          1|\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- aov_ez(id = \"id\",\n              dv = \"imscore\",\n              between = \"waiting\",\n              within = \"ratingtype\",\n              data = HOSM22_E3)\n\n# Obtain MANOVA table\nMANOVA_tab <- mod$Anova # same as below\n```\n:::\n\n::: {#tbl-MANOVA .cell tbl-cap='Type III Repeated Measures MANOVA Tests: Pillai test statistic'}\n\n```{.r .cell-code}\n# Fit instead the model with MANOVA using multivariate linear regression\nmanova_mod <- lm(cbind(prediction, experience) ~ waiting,\n                 data = HOSM22_E3w)\n# For repeated measures, we need to reconstruct the missing factor(s)\n# corresponding to the repeated measures via a data frame (idata)\n# that contains the factor levels and the variable name\n# and idesign that includes the additional factors to our models\ncar::Anova(manova_mod,\n           idata = data.frame(\n             ratingtype = factor(c(\"prediction\",\"experience\"))),\n           idesign =~ratingtype, type = 3) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nType III Repeated Measures MANOVA Tests: Pillai test statistic\n                   Df test stat approx F num Df den Df  Pr(>F)    \n(Intercept)         1     0.893      508      1     61 < 2e-16 ***\nwaiting             1     0.156       11      1     61  0.0014 ** \nratingtype          1     0.387       38      1     61 5.4e-08 ***\nwaiting:ratingtype  1     0.001        0      1     61  0.7757    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fitting the same 2x2 model (with interaction), including a random intercept per subject\nlibrary(lmerTest)\nmixmod <- lmer(\n  imscore ~ waiting*ratingtype + (1 | id),\n  data = HOSM22_E3)\n# We get the same table if we set type III\nanova(mixmod, type = 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nType II Analysis of Variance Table with Satterthwaite's method\n                   Sum Sq Mean Sq NumDF DenDF F value  Pr(>F)    \nwaiting              7.76    7.76     1    61   11.26  0.0014 ** \nratingtype          26.47   26.47     1    61   38.39 5.5e-08 ***\nwaiting:ratingtype   0.06    0.06     1    61    0.08  0.7757    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n## Curley et al.\n\nThis is an incomplete block design: there are two (counterbalanced) combinations of `anchor`, `vignette`, and `verdictsyst`, but participants see 2 out of 8 combinations. Hence, no interaction between these and ID is possible.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(C22, package = \"hecedsm\")\nhead(C22)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 7\n  anchor       vignette id    vorder verdictsyst guilt  pjaq\n  <fct>        <fct>    <fct> <fct>  <fct>       <dbl> <dbl>\n1 strong-first 1        1     1      two         104.     67\n2 strong-first 1        2     1      two          81.8   101\n3 strong-first 1        3     1      two          87.8    65\n4 strong-first 1        4     1      two          82.7    60\n5 strong-first 1        5     1      two          76.8    75\n6 strong-first 1        6     1      two          96.2    73\n```\n\n\n:::\n\n```{.r .cell-code}\noptions(contrasts = c(\"contr.sum\", \"contr.poly\"))\n# balanced!\nxtabs(~ anchor + vignette + verdictsyst, data = C22)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , verdictsyst = two\n\n              vignette\nanchor          1  2\n  weak-first   32 32\n  strong-first 32 32\n\n, , verdictsyst = three\n\n              vignette\nanchor          1  2\n  weak-first   32 32\n  strong-first 32 32\n```\n\n\n:::\n\n```{.r .cell-code}\nxtabs(~  interaction(anchor, vignette, verdictsyst) + id, data = C22)[,1:5]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                          id\ninteraction(anchor, vignette, verdictsyst) 1 2 3 4 5\n                      weak-first.1.two     0 0 0 0 0\n                      strong-first.1.two   1 1 1 1 1\n                      weak-first.2.two     0 0 0 0 0\n                      strong-first.2.two   0 0 0 0 0\n                      weak-first.1.three   0 0 0 0 0\n                      strong-first.1.three 0 0 0 0 0\n                      weak-first.2.three   1 1 1 1 1\n                      strong-first.2.three 0 0 0 0 0\n```\n\n\n:::\n\n```{.r .cell-code}\nmodel <- lmer(\n  guilt ~ anchor*vignette*verdictsyst + pjaq + (1|id),\n  data = C22)\n# pjaq is a covariate (so used to reduce error, plus the slope is of interest on it's own\n# Cannot have interaction pjaq * id, because we get a single pjaq score per person\n\n# No ambiguity for sum of square decomposition\nanova(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nType III Analysis of Variance Table with Satterthwaite's method\n                            Sum Sq Mean Sq NumDF DenDF F value  Pr(>F)    \nanchor                        1601    1601     1   124    7.49  0.0071 ** \nvignette                      2251    2251     1   124   10.53  0.0015 ** \nverdictsyst                    296     296     1   124    1.39  0.2413    \npjaq                          4277    4277     1   123   20.00 1.7e-05 ***\nanchor:vignette                  4       4     1   123    0.02  0.8959    \nanchor:verdictsyst               3       3     1   123    0.01  0.9028    \nvignette:verdictsyst          1238    1238     1   123    5.79  0.0176 *  \nanchor:vignette:verdictsyst      4       4     1   124    0.02  0.8945    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n# No three-way interaction\n# A two-way interaction between vignette:verdictsyst\n# Computing differences between anchors\nemmeans(model, specs = \"anchor\") |> pairs()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n contrast                      estimate   SE  df t.ratio p.value\n (weak-first) - (strong-first)        5 1.83 124   2.736  0.0071\n\nResults are averaged over the levels of: vignette, verdictsyst \nDegrees-of-freedom method: kenward-roger \n```\n\n\n:::\n\n```{.r .cell-code}\n# Computing differences in verdict separately for each vignette\nemmeans(model, specs = \"verdictsyst\", by = \"vignette\") |> pairs()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nvignette = 1:\n contrast    estimate   SE  df t.ratio p.value\n two - three     11.1 4.14 179   2.678  0.0081\n\nvignette = 2:\n contrast    estimate   SE  df t.ratio p.value\n two - three     -6.8 4.14 179  -1.640  0.1028\n\nResults are averaged over the levels of: anchor \nDegrees-of-freedom method: kenward-roger \n```\n\n\n:::\n:::\n\n\n\n## Chocolate rating\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbook.url <- \"http://stat.ethz.ch/~meier/teaching/book-anova\"\nchocolate <- read.table(file.path(book.url, \"data/chocolate.dat\"),\n                        header = TRUE)\nchocolate[,\"rater\"]      <- factor(chocolate[,\"rater\"])\nchocolate[,\"background\"] <- factor(chocolate[,\"background\"])\nstr(chocolate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t160 obs. of  4 variables:\n $ choc      : chr  \"A\" \"A\" \"B\" \"B\" ...\n $ rater     : Factor w/ 10 levels \"1\",\"2\",\"3\",\"4\",..: 1 1 1 1 1 1 1 1 2 2 ...\n $ background: Factor w/ 2 levels \"rural\",\"urban\": 1 1 1 1 1 1 1 1 1 1 ...\n $ y         : int  61 64 46 45 63 66 59 56 65 69 ...\n```\n\n\n:::\n\n```{.r .cell-code}\n# Fit the model (note that rater recycles the id 1:10, so we need to be careful here!\nchocolate <- chocolate |> dplyr::mutate(id = factor(paste(background, rater)))\n# This model is correct\nmodel <- lmer(y ~ background*choc +\n                (1 | rater:background) + (1 | rater:choc:background),\n              data = chocolate)\n# This is fine too (because of the distinct IDs)\nmodel <- lmer(y ~ background*choc +\n                (1 | id) + (1 | choc:id),\n              data = chocolate)\n# This is WRONG (compare degrees of freedom)\n# model <- lmer(y ~ background*choc +\n#                 (1 | rater) + (1 | choc:rater),\n#               data = chocolate)\n# Data are again balanced\nanova(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nType III Analysis of Variance Table with Satterthwaite's method\n                Sum Sq Mean Sq NumDF DenDF F value  Pr(>F)    \nbackground         263     263     1    18   27.61 5.4e-05 ***\nchoc              4219    1406     3    54  147.74 < 2e-16 ***\nbackground:choc     64      21     3    54    2.24   0.094 .  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n# There is a no evidence of interaction\n# The model output includes variance coefficients\nsummary(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: y ~ background * choc + (1 | id) + (1 | choc:id)\n   Data: chocolate\n\nREML criterion at convergence: 921\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-2.2380 -0.4833 -0.0244  0.4950  2.2997 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n choc:id  (Intercept)  9.42    3.07    \n id       (Intercept) 19.63    4.43    \n Residual              9.52    3.09    \nNumber of obs: 160, groups:  choc:id, 80; id, 20\n\nFixed effects:\n                  Estimate Std. Error      df t value Pr(>|t|)    \n(Intercept)         70.819      1.076  18.000   65.79  < 2e-16 ***\nbackground1         -5.656      1.076  18.000   -5.25  5.4e-05 ***\nchoc1                5.431      0.729  54.000    7.45  7.7e-10 ***\nchoc2              -14.844      0.729  54.000  -20.35  < 2e-16 ***\nchoc3                7.881      0.729  54.000   10.81  4.1e-15 ***\nbackground1:choc1   -0.394      0.729  54.000   -0.54     0.59    \nbackground1:choc2   -0.519      0.729  54.000   -0.71     0.48    \nbackground1:choc3   -0.944      0.729  54.000   -1.29     0.20    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) bckgr1 choc1  choc2  choc3  bck1:1 bck1:2\nbackground1  0.000                                          \nchoc1        0.000  0.000                                   \nchoc2        0.000  0.000 -0.333                            \nchoc3        0.000  0.000 -0.333 -0.333                     \nbckgrnd1:c1  0.000  0.000  0.000  0.000  0.000              \nbckgrnd1:c2  0.000  0.000  0.000  0.000  0.000 -0.333       \nbckgrnd1:c3  0.000  0.000  0.000  0.000  0.000 -0.333 -0.333\n```\n\n\n:::\n\n```{.r .cell-code}\n# Look at best chocolate type overall\n(emm <- emmeans(model, specs = \"choc\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n choc emmean  SE   df lower.CL upper.CL\n A      76.2 1.3 35.8     73.6     78.9\n B      56.0 1.3 35.8     53.3     58.6\n C      78.7 1.3 35.8     76.1     81.3\n D      72.3 1.3 35.8     69.7     75.0\n\nResults are averaged over the levels of: background \nDegrees-of-freedom method: kenward-roger \nConfidence level used: 0.95 \n```\n\n\n:::\n\n```{.r .cell-code}\nemm |> contrast(\"pairwise\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n contrast estimate   SE df t.ratio p.value\n A - B       20.27 1.19 54  17.030  <.0001\n A - C       -2.45 1.19 54  -2.060  0.1803\n A - D        3.90 1.19 54   3.270  0.0097\n B - C      -22.72 1.19 54 -19.080  <.0001\n B - D      -16.37 1.19 54 -13.750  <.0001\n C - D        6.35 1.19 54   5.330  <.0001\n\nResults are averaged over the levels of: background \nDegrees-of-freedom method: kenward-roger \nP value adjustment: tukey method for comparing a family of 4 estimates \n```\n\n\n:::\n\n```{.r .cell-code}\n# C has the highest rating, but indistinguishable from A\n# B is worst\n\n# Compare variability - extract variance from model\n(vars <- c(unlist(VarCorr(model)), sigma(model)^2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nchoc:id      id         \n   9.42   19.63    9.52 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Compare these with the output of summary\n# Correlation between same chocolate/rater\nsum(vars[1:2])/sum(vars)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.753\n```\n\n\n:::\n\n```{.r .cell-code}\n# Correlation between measurements from same rater, different chocolates\nvars[2]/sum(vars)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   id \n0.509 \n```\n\n\n:::\n:::\n",
    "supporting": [
      "MATH80667A-10-content_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}