{
  "hash": "43c2427a5e0fdf027ed11fdf6b6042e8",
  "result": {
    "markdown": "---\ntitle: \"Three-way analysis of variance\"\nlinktitle: \"Three-way ANOVA\"\ntype: docs\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: true\n  eval: true\n  message: false\n  warning: false\n  cache: true\n  fig-align: 'center'\n  out-width: '80%'\n---\n\n\n\n\n# Videos\n\nThe **R** code created in the video [can be downloaded here](/example/threewayanova.R) and the [SPSS code here](/example/threeway.sps).\n\n\n::: {.cell hash='threewayanova_cache/html/show-youtube-list_b713a0f65dcf649ccf3dfe351d9d93bf'}\nThere's a set of videos that walks through each section below. To make it easier for you to jump around the video examples, I cut the long video into smaller pieces and included them all in [one YouTube playlist](https://www.youtube.com/playlist?list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY).\n\n- [Introduction](https://www.youtube.com/watch?v=SHhP_TfZGVM&list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY)\n- [Interaction plots](https://www.youtube.com/watch?v=I63CNxonlow&list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY)\n- [Marginal contrast and simple effects](https://www.youtube.com/watch?v=KLLBNQhD0rE&list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY)\n- [More contrasts and interactions](https://www.youtube.com/watch?v=WIoxZZ4pvlE&list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY)\n- [SPSS walkthrough](https://www.youtube.com/watch?v=_imWUkEQVo8&list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY)\n\nYou can also watch the playlist (and skip around to different sections) here:\n\n<div class=\"ratio ratio-16x9\">\n<iframe src=\"https://www.youtube.com/embed/playlist?list=PLUB8VZzxA8IvjcV7Yl-OW_9KI6f_2K5HY\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n</div>\n:::\n\n\n\n# Notebook\n\nThe purpose of this little demonstration is to reproduce the results from chapter 21 and 22 of @Keppel/Wickens:2004, which were performed manually, using instead the `emmeans` package. Many of the manipulations are intricate.\n\nWe consider fictional data from @Keppel/Wickens:2004 for a study on \n\n> the effects of verbal feedback given during the acquisition of different types of learning material on memory tested one week later.\n\n## Data description\n\nThere are three factors: the first is `feedback`, which indicates the type of verbal feedback received by the participant: either `none` ($a_1$) to serve as control group, `positive` ($a_2$) or `negative` ($a_3$) feedback. The second factor is related to the type of learning material, one of low-frequency words with low emotional content ($b_1$), high-frequency words with low emotional content ($b_2$) and finally high-frequency words with high emotional content ($b_3$). The third factor is the target population: either fifth graders ($c_1$) or high school seniors ($c_2$). While most of the interest is in the first two factors, the three-way ANOVA is a more efficient design if we want to study both age groups.\n\nThe response variable is the number of words remembered (`words`) after one week. The design is balanced: there are $r=5$ replications for each scenario, so $n=3 \\times 3 \\times 2 \\times 5$ observations. If we fit the three-way model with all two ways and three way interactions, we need to estimate 19 parameters (18 means and one variance). We model each participant response assuming the measurements are independent and $Y_{ijkr} \\sim \\mathsf{No}(\\mu_{ijk}, \\sigma^2)$: this indicates that each subgroup ($a_i, b_j, c_k$) has a different (theoretical) average $\\mu_{ijk}$ and a common variance $\\sigma^2$. The estimates $\\widehat{\\mu}_{ijk}$ are simply the sample averages of each group, whereas the pooled variance estimator, $$\\widehat{\\sigma}^2 = \\frac{1}{72}\\sum_{i=1}^3 \\sum_{j=1}^3 \\sum_{k=1}^2 \\sum_{r=1}^5 (y_{ijkr} - \\widehat{\\mu}_{ijk})^2,$$\nis the sum of squared difference between replicate observations and their group average, divided by the residual degrees of freedom (total number of observations minus number of mean parameters).\n\nThe model can be reparametrized in terms of main effects and interaction: overall average for each factor, average of residual affect after accounting for effects of row, columns and depth and finally residual affect for the three-way. This parametrization is \n$$\\begin{align*}\\underset{\\text{theoretical average}}{\\mathsf{E}(Y_{ijkr})} &= \\quad \\underset{\\text{global mean}}{\\mu} \\\\ &\\quad +\\underset{\\text{main effects}}{\\alpha_i + \\beta_j + \\gamma_k}  \\\\ & \\quad + \\underset{\\text{two-way interactions}}{(\\alpha\\beta)_{ij} + (\\alpha\\gamma)_{ik} + (\\beta\\gamma)_{jk}} \\\\ & \\quad + \\underset{\\text{three-way interaction}}{(\\alpha\\beta\\gamma)_{ijk}}\\end{align*}$$\n\n## Setup\n\nWhat are comparisons of interest? We may be interested in the effect of feedback, for example comparing whether any form of feedback increases word retention. Thus, we could look at the marginal contrast $\\mu_{1..} = \\frac{1}{2}(\\mu_{2..} + \\mu_{3..})$, in essence treating the whole model as a one-way ANOVA but using all the data to estimate the standard deviation $\\sigma$. For a balanced sample, the estimated average for example of the control group `none`, $\\widehat{\\mu}_{1..}$, would be the sample average of the 30 participants assigned to this experimental condition.\n\nWe can proceed similarly for the other factors. One could be interested in whether the type of learning material impacts retention (overall effect), or if there are difference between high and low emotional content for high-frequency occurrences ($b_2$ and $b_3$); amounting to ignoring all observations for the low emotion low-frequency group. \n\nThe first step is to load the data and the packages needed for the analysis.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-1_305e703d595d21d6df1e078a712a4a5e'}\n\n```{.r .cell-code}\n# Load packages\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(emmeans)\n# Load data\ndata(words, package = 'hecedsm')\n# Check balance\nxtabs(~feedback + age + material, \n      data = words)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n, , material = low freq/low emotion\n\n          age\nfeedback   fifth grade senior\n  none               5      5\n  positive           5      5\n  negative           5      5\n\n, , material = high freq/low emotion\n\n          age\nfeedback   fifth grade senior\n  none               5      5\n  positive           5      5\n  negative           5      5\n\n, , material = high freq/high emotion\n\n          age\nfeedback   fifth grade senior\n  none               5      5\n  positive           5      5\n  negative           5      5\n```\n:::\n:::\n\n\nThis is a 3 by 3 by 2 factorial design with $r=5$ replicates.\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-2_1da35a69e127515bf84dfbc0b26784fa'}\n\n```{.r .cell-code}\nmodel <- aov(words ~ feedback * material * age,\n            data = words)\nanova(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: words\n                      Df  Sum Sq Mean Sq F value    Pr(>F)    \nfeedback               2  26.867  13.433  7.1118  0.001519 ** \nmaterial               2  64.867  32.433 17.1706 7.993e-07 ***\nage                    1  14.400  14.400  7.6235  0.007304 ** \nfeedback:material      4  14.667   3.667  1.9412  0.112829    \nfeedback:age           2   8.600   4.300  2.2765  0.109987    \nmaterial:age           2  16.200   8.100  4.2882  0.017397 *  \nfeedback:material:age  4  10.000   2.500  1.3235  0.269461    \nResiduals             72 136.000   1.889                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nSince the data are balanced, we can use the `aov` function and look at the analysis of variance produced by `aov`.^[With unbalanced data, we would need to fit the model using `lm` and use `car::Anova` to get type 2 or 3 effects.] To get all pairwise and the triplewise interaction, we use `response ~ factor1 * factor2 * factor3` notation. Since we have replications, the full model doesn't fit the data exactly and there are residual observations to estimate the variability, but estimating reliably different variance in each of the 18 subgroup wouldn't be possible with 5 observations. We can see that the three-way interaction isn't significative, and the only two-way effect is for `material:age`.\n\n## Interaction plot \n\n\nWe can try to infer whether there is an interaction by looking at averages for each pair of variable at a time, and then at all three factors concurrently. These plots theoretically are used to demonstrate the impact of interactions, but in practice the sample estimates are noisy proxies of the true subgroup averages.\n\nWe can confirm our findings by looking at the interaction plot, showing the group average for each combination of the factors.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-3_52fa44120ed3e5ecb46c47b8bc6de101'}\n\n```{.r .cell-code}\nwords |>\n  group_by(feedback, material, age) |>\n  summarize(meanwords = mean(words)) |>\nggplot(mapping = aes(x = feedback,\n                     y = meanwords,\n                     group = material,\n                     color = material)) +\n  geom_line() + # connect the dots\n  facet_wrap(~age) +\n  labs(subtitle = \"mean number of words remembered\",\n       y = \"\") +\n  theme_classic() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](threewayanova_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nThese summary statistics hide the raw data: due to the discreteness of the response, which consists of counts, we can slightly perturb observations and jitter them. \n\n\n\n::: {.cell hash='threewayanova_cache/html/fig-raw-words_564b2625fc69531e158271485a0eb450'}\n\n```{.r .cell-code}\nggplot(data = words,\n         mapping = aes(x = age,\n                       y = words,\n                       group = material,\n                       color = material)) +\n  geom_point(position = position_jitterdodge(jitter.height = 0.1,\n                                             dodge.width = 0.3)) +\n  facet_wrap(~feedback) + # wrap by third variable\n  theme_classic() + # change default theme\n  theme(legend.position = \"bottom\") + # move caption\n  labs(subtitle = \"mean number of words remembered\",\n       y = \"\")\n```\n\n::: {.cell-output-display}\n![Individual results for an experiment on the impact of verbal feedback on retention of information.](threewayanova_files/figure-html/fig-raw-words-1.png){#fig-raw-words width=672}\n:::\n:::\n\n\nThe high frequency/high emotion group has significantly lower retention depending on feedback, with seemingly no difference with other material type when there is no verbal feedback, but a strong decrease for positive and even stronger for negative feedback. By contrasts, there is little to no effect with high school seniors, suggesting that the experimental manipulation has limited impact for these groups.\n\n## Main effects and contrasts\n\nThe whole purpose of Chapters 21 and 22 is to show how we can explore the three-way factorial design and extract information by treating it as a one-way ANOVA with 18 groups, a series of two-way ANOVA, etc.\n\nWe look at the estimated marginal means and start by computing the marginal mean by averaging over levels of material and age, since there did not seem to be interaction between feedback and the other variables.\n\nAs before with the `emmeans` package, we specify the variables we want to keep in `specs`, the other being 'marginalized out' by ignoring the counts. The package will print a warning since the model includes an interaction, indicating that the output is potentially misleading.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-5_aa4548e22ea99337eddd0bb78b654bf0'}\n\n```{.r .cell-code}\nmargA <- emmeans(model, specs = \"feedback\")\nmargA\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n feedback emmean    SE df lower.CL upper.CL\n none       8.37 0.251 72     7.87     8.87\n positive   7.30 0.251 72     6.80     7.80\n negative   7.13 0.251 72     6.63     7.63\n\nResults are averaged over the levels of: material, age \nConfidence level used: 0.95 \n```\n:::\n:::\n\n\nSince the data are balanced, this is simply the average words recalled per feedback group. We can check that this is indeed the mean of each word count by feedback by computing the summary statistics and comparing them with the output of `emmeans`:\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-6_a8e39bb61923105dc1f5a3202efe2771'}\n\n```{.r .cell-code}\nwords |>\n    group_by(feedback) |>\n    summarize(mean = mean(words))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  feedback  mean\n  <fct>    <dbl>\n1 none      8.37\n2 positive  7.3 \n3 negative  7.13\n```\n:::\n:::\n\n\n### Marginal contrast\n\nWe next compute a marginal contrast by comparing between no-feedback and the average of positive and negative. This amounts to treating our data as a one-way ANOVA and computing contrasts as usual.\n\n\nThe null hypothesis is \n$$\\mathscr{H}_0: \\mu_{\\text{none}..} = \\frac{1}{2} \\left(\\mu_{\\text{pos}..} + \\mu_{\\text{neg}..}\\right)$$ which can be rexpressed in terms of contrast vector as $(1, -0.5, -0.5)$ or any non-zero multiple of this solution.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-7_271969b528a95066feab7e00a57688bb'}\n\n```{.r .cell-code}\ncontrast(object = margA,\n         method = list(interaction = c(1, -0.5, -0.5)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast    estimate    SE df t.ratio p.value\n interaction     1.15 0.307 72   3.742  0.0004\n\nResults are averaged over the levels of: material, age \n```\n:::\n:::\n\n\n### Simple effects\n\nSince the two-way interaction between factors `material` and `age` is significant, we can test for differences between levels of `material` within each value of `age` (averaging over all levels of `feedback`).\n\n\nTo do this with `emmeans`, we first marginalize out over feedback by keeping only the two other variables in `specs`, then perform an $F$ test for each value of `age` by using `joint_tests` and specifying the analysis is conditional on `age`.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-8_f78974b15e26a353bf795a40138bfb87'}\n\n```{.r .cell-code}\nsimpleBpC <-\n  emmeans(model,\n          specs = c(\"material\", \"age\")) |>\n  joint_tests(by = \"age\")\nsimpleBpC\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage = fifth grade:\n model term df1 df2 F.ratio p.value\n material     2  72  19.306  <.0001\n\nage = senior:\n model term df1 df2 F.ratio p.value\n material     2  72   2.153  0.1236\n```\n:::\n:::\n\n\nWe could also look at **simple contrasts** by levels of age comparing the three material and looking at low versus high emotions. This amounts to reducing data to a two-way ANOVA in a first step, then taking each depth (age) group in turn and computing a contrast.\n\nUsing the notation $A \\times B \\times C$ to denote the feedback, material and age groups, this compares\n\n$$\\mathscr{H}_0: \\frac{1}{2} \\left(\\mu_{.1k} + \\mu_{.2k}\\right) = \\mu_{.3k}$$\nfor age group $k$. \n\nIn both cases, we get two sets of tests statistics and $p$-values since there are two age groups.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-9_4f4d86a1121239091ff2c81a4c181f3f'}\n\n```{.r .cell-code}\n# Simple contrasts\nmargBC <- emmeans(model,\n                  specs = c(\"material\", \"age\"),\n                  by = \"age\")\nlevels(margBC)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$material\n[1] \"low freq/low emotion\"   \"high freq/low emotion\"  \"high freq/high emotion\"\n\n$age\n[1] \"fifth grade\" \"senior\"     \n```\n:::\n\n```{.r .cell-code}\nmargBC |>\n  contrast(method = list(contrast = c(-0.5, -0.5, 1)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage = fifth grade:\n contrast estimate    SE df t.ratio p.value\n contrast     -2.7 0.435 72  -6.212  <.0001\n\nage = senior:\n contrast estimate    SE df t.ratio p.value\n contrast     -0.9 0.435 72  -2.071  0.0420\n\nResults are averaged over the levels of: feedback \n```\n:::\n:::\n\n\nThere is strong (unadjusted) differences between low and high emotion for fifth grades, but the effect for senior is smaller and quite uncertain.\n\n### Interaction components\n\nThe next potential object of interest is the interaction components based on marginal means. \n\n@Keppel/Wickens:2004 compare the average of $b_2$ and $b_3$ between age groups, fixing the frequency and varying only the emotional content. \n\nThe first step with `emmeans` is to specify which variables to keep, then slice by age group. This gives us a set of 3 averages per age group. Next, we set up the contrast vector to compute for each age group. The last call, to `joint_tests()`, proceeds with comparing whether the average contrast results are the same in each age group by comparing the two. There is some evidence that high emotion words has a different impact, independent of feedback. \n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-10_a202e3b2dcfab6f850a433e10c073a42'}\n\n```{.r .cell-code}\nemmeans(model,\n        specs = c(\"material\", \"age\"),\n        by = \"age\") |>\n  contrast(method = list(b2vsb3 = c(0, 1, -1))) |>\n  joint_tests()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n model term df1 df2 F.ratio p.value\n age          1  72   6.432  0.0134\n```\n:::\n:::\n\n\nWe could also compute differences between feedback and material. Marginalizing over age yields a total of 9 cells: we treat the resulting two-way design as a one-way design with nine groups and simply compute the contrast vector, assigning weight zero for the low-frequency and low emotion group and then looking at none (weight $1$) and the average of positive and negative feedback (weights of $-0.5$). Since we want to compare this difference between $b_2$ and $b_3$, we give similar weights for the last three groups, but instead of $(1, -0.5, -0.5)$, we flip the signs.\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-11_e45f8641dcaf7a5d9dbe21d3b46a87eb'}\n\n```{.r .cell-code}\nemmAB <- emmeans(model, \n        specs = c(\"feedback\", \"material\"))\nlevels(emmAB)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$feedback\n[1] \"none\"     \"positive\" \"negative\"\n\n$material\n[1] \"low freq/low emotion\"   \"high freq/low emotion\"  \"high freq/high emotion\"\n```\n:::\n\n```{.r .cell-code}\ncontr <- list(\"none vs feedback for b2 vs b3\" =\n  c(0, 0, 0, -1, 0.5, 0.5, 1, -0.5, -0.5)\n)\n\nemmAB |>\n  contrast(method = contr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast                      estimate    SE df t.ratio p.value\n none vs feedback for b2 vs b3      1.4 0.753 72   1.860  0.0670\n\nResults are averaged over the levels of: age \n```\n:::\n:::\n\n\n### Three factor interaction\n\nThe most complicated type of comparison is the three factor interaction (which wasn't deemed significant). We could look at a particular combination by looking at the difference of difference. This is the same as what we just computed, but this time we will compare this difference of difference between age groups to see if it is the same.\n\n- $A$ (`feedback`): no feedback vs feedback (`none` vs average of `pos` and `neg`), \n- $B$ (`material`): comparing low vs high emotional feedback (`b2` vs `b3`) \n- $C$: fifth graders vs seniors\n\n\n::: {.cell hash='threewayanova_cache/html/unnamed-chunk-12_3a8b4d94496f7e002c33db5b255785e7'}\n\n```{.r .cell-code}\nthreewaycontrast <- \n  emmeans(model, \n          specs = c(\"feedback\", \"material\",\"age\")) |>\n  contrast(method = list(\n    contrast =c(0, 0, 0, -1, 0.5, 0.5,\n                1, -0.5, -0.5, 0, 0, 0,\n                1, -0.5, -0.5, -1, 0.5, 0.5)))\nsummary(threewaycontrast, \n        adjust = \"scheffe\",\n        scheffe.rank = 17)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate   SE df t.ratio p.value\n contrast        3 1.51 72   1.993  0.9992\n\nP value adjustment: scheffe method with rank 17 \n```\n:::\n:::\n\n\nWe can adjust for multiplicity by using Scheffé's method, but we need to set up the rank of the test: for general contrasts in a two-way slice, this would be the number of groups minus one, so 8 if we look at feedback and material, 2 if we look only at the feedback type, etc.\n\n\nThere is no evidence here that this setup comparison for looking at differences for feedback among high frequency groups is any different between age groups.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}